function B(h){console.log("âš¡ [Pulse Preview] Engine v2.2 Activated. Vandal Sync Ready."),k();let p=[],b=[],E={},u=!1;function q(i={}){const e=document.documentElement;Object.entries(i).forEach(([n,r])=>{const a=n.startsWith("--")?n:`--${n.replace(/\./g,"-")}`;e.style.setProperty(a,r);const t=n.split(".").pop()||"";t==="primary"&&e.style.setProperty("--primary-color",r),t==="secondary"&&e.style.setProperty("--secondary-color",r),t==="background"&&e.style.setProperty("--bg-color",r),t==="text"&&e.style.setProperty("--text-color",r),t==="muted"&&e.style.setProperty("--muted-color",r),(t==="cardBackground"||t==="cardBg")&&e.style.setProperty("--card-bg-color",r),(t==="cardBorder"||t==="border")&&e.style.setProperty("--card-border-color",r)})}function z(i){if(!i)return;const{palette:e={},computed:n={}}=i,r={};e.primary&&(r["--primary-color"]=e.primary),e.secondary&&(r["--secondary-color"]=e.secondary),e.accent&&(r["--accent-color"]=e.accent),e.background&&(r["--bg-color"]=e.background),e.text&&(r["--text-color"]=e.text),e.muted&&(r["--muted-color"]=e.muted),Object.entries(n).forEach(([a,t])=>{if(a==="isDark"||a==="dark"){const o=t==="true"||t===!0;document.documentElement.classList.toggle("dark",o);return}r[`--${a}`]=t,a==="background"&&(r["--bg-color"]=t),a==="text"&&(r["--text-color"]=t),a==="primary"&&(r["--primary-color"]=t),a==="secondary"&&(r["--secondary-color"]=t),a==="accent"&&(r["--accent-color"]=t),a==="muted"&&(r["--muted-color"]=t)}),q(r),console.log("[Preview] Vandal Palette Sync:",Object.keys(r).length,"variables updated.")}function S(i){const{sections:e}=i,n=document.querySelector('[data-page-type="home"]');if(!n)return;console.log("[Preview] Syncing Layout sequence...");const r=document.createDocumentFragment();e.forEach(a=>{const t=n.querySelector(`[data-zflex-section="${a.type}"]`);t&&r.appendChild(t)}),n.innerHTML="",n.appendChild(r),h&&h()}async function w(i){const{type:e,html:n}=i,r=document.querySelector('[data-page-type="home"]');if(!r)return;console.log(`[Preview] Injecting template: ${e}`);const a=document.createElement("div");a.innerHTML=n.trim();const t=a.firstElementChild;if(!t)return;let o=r.querySelector(`[data-zflex-section="${e}"]`);o||(o=document.createElement("div"),o.setAttribute("data-zflex-section",e),r.appendChild(o)),o.innerHTML=t.outerHTML,f(o),h&&h()}function $(i){const{id:e,variant:n,data:r}=i;console.log(`[Preview] Variant update: ${e} -> ${n}`,r);const a=document.querySelector(`[data-zflex-section="${e}"]`);if(!a){console.warn(`[Preview] Section ${e} not found, can't update variant`);return}if(a.setAttribute("data-variant",n),a.querySelectorAll("[data-variant]").forEach(o=>{o.setAttribute("data-variant",n)}),r&&Object.keys(r).forEach(o=>{const s=`${e}.${o}`,c=r[o];o==="style"||o==="variant"||o==="layout"||m({id:s,value:c})}),e==="productCard"||e==="productCard.style"){P(n||r&&(r.variant||r.style));return}u||f(a,!0),console.log(`[Preview] âœ… Variant ${e} updated to ${n} (propagated to children)`)}function P(i){const e=i||document.querySelector('div[data-zflex-section="productCard"][data-variant]')?.getAttribute("data-variant")||"clean",n=document.querySelector(`template[data-zflex-variant="productCard.${e}"]`),r=document.querySelector('template[data-zflex-template="productCard.card"]');if(n&&r){r.innerHTML="";const a=n.content.cloneNode(!0);r.content.appendChild(a),y({id:"featuredProducts"}),y({id:"catalog"}),console.log(`[Preview] ðŸ”„ Product Card Blueprint refreshed to: ${e}`)}else console.warn(`[Preview] âš ï¸ Failed to refresh blueprint: sub=${!!n}, main=${!!r}`)}async function y(i){const{id:e,products:n,category:r}=i,a=document.querySelector('template[data-zflex-template="productCard.card"]');if(!a)return;const t=document.querySelector(`[data-zflex-id="${e}"] .grid`)||document.querySelector(`[data-zflex-section="${e}"] .grid`)||document.querySelector(`[data-zflex-section="${e.split(".")[0]}"] .grid`)||document.querySelector(`[data-page-type="${e}"] .grid`);if(t){let o=n||(r?L(r):[]);o.length===0&&!n&&!r&&(e.includes("featuredProducts")?o=b.length>0?b:p.slice(0,4):e.includes("catalog")&&(o=p)),C(t,o,a,e.includes("featuredProducts")?4:24)}}function C(i,e,n,r=8){if(!i||!n)return;i.innerHTML="",e.slice(0,r).forEach((t,o)=>{const c=n.content.cloneNode(!0).firstElementChild;c&&(I(c,t,`product.${o}`),i.appendChild(c))}),u||f(i,!0)}function L(i){return p.filter(e=>e.category===i||e.categories&&e.categories.includes(i)||e.categoryId===i)}function I(i,e,n){i.querySelectorAll("[data-zflex-bind]").forEach(a=>{const t=a.getAttribute("data-zflex-bind");if(!t)return;let o=e[t];typeof o=="object"&&o!==null&&(t==="price"?o=o.formatted||o.text||(o.amount!==void 0?`${o.amount} ${o.currency||"â‚¬"}`:""):t==="stock"?o.status==="illimite"||o.status==="unlimited"?o="âˆž":o=o.quantity!==void 0?o.quantity:o.status||"":t==="image"||t.includes("Image")?o=o.url||o.src||"":o=""),(o==null||o==="")&&(t==="image"&&(o=e.coverImage||e.imageUrl||e.image||""),t==="price"&&(o=e.priceText||(typeof e.price=="number"?`${e.price} â‚¬`:"0.00 â‚¬")),t==="stock"&&(o="âˆž"));const s=`${n}.${t}`;a.setAttribute("data-zflex-id",s),x(a,s,o,!0)})}function x(i,e,n,r=!1){const a=i.tagName.toUpperCase(),t=(e.toLowerCase().includes("image")||e.toLowerCase().includes("logo"))&&!e.toLowerCase().includes("text"),o=e.toLowerCase().includes("bg")&&!e.toLowerCase().includes("text"),s=typeof n=="string"&&n.startsWith("data:image")&&n.length>5e5;if(a==="IMG")n&&n!=="undefined"&&(i.src=n);else if(a==="INPUT")i.value=n;else if(a==="A"&&e.endsWith("Link"))i.href=n;else if(a==="I"||i.classList.contains("fa")||e.includes(".icon"))i.className=n;else if((t||o||i.style.backgroundImage)&&typeof n=="string"&&(n.includes("http")||n.includes("/")||n.includes("data:image"))){const c=n&&n!=="undefined"?`url('${n}')`:"none";i.style.getPropertyValue("--bg-image")!==""?(i.style.setProperty("--bg-image",c),s&&(i.style.backgroundImage=c)):i.style.getPropertyValue("--zflex-img-url")!==""?(i.style.setProperty("--zflex-img-url",c),s&&(i.style.backgroundImage=c)):i.style.backgroundImage=c}else i.innerHTML=n??"";u||(s?setTimeout(()=>f(i,!0),400):f(i,!r))}function m(i,e=!1){const{id:n,value:r}=i;if(n.includes("palette.")||n.includes("computed.")||n.includes("typography.")){const t=n.split("."),o=t[t.length-1],s=o.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),c=s.endsWith("-color")?`--${s}`:`--${s}-color`;document.documentElement.style.setProperty(c,r),document.documentElement.style.setProperty(`--${o}`,r),o==="background"&&document.documentElement.style.setProperty("--bg-color",r),o==="text"&&document.documentElement.style.setProperty("--text-color",r),o==="primary"&&document.documentElement.style.setProperty("--primary-color",r),o==="secondary"&&document.documentElement.style.setProperty("--secondary-color",r);return}if(n==="buttons.radius"||n.includes("buttons.radius")){document.body.setAttribute("data-button-radius",r),document.documentElement.style.setProperty("--btn-radius",r);return}if(n==="ui.borderWidth"||n.includes("ui.borderWidth")){document.documentElement.style.setProperty("--border-width",r);return}if(n.includes("marquee.speed")){document.querySelectorAll(".pulse-marquee").forEach(o=>o.style.animationDuration=r);return}if(n.includes("marquee.reverse")){document.querySelectorAll(".pulse-marquee").forEach(o=>o.style.animationDirection=r?"reverse":"normal");return}if(n==="productReveal.productId"){const t=p.find(o=>o.id===r);t&&(m({id:"productReveal.title",value:t.title},!0),m({id:"productReveal.description",value:t.description||t.shortDescription||""},!0),m({id:"productReveal.image",value:t.coverImage||t.image},!0),document.querySelectorAll('[data-zflex-id="productReveal.productId"]').forEach(c=>c.setAttribute("data-add-to-cart",t.id)),document.querySelectorAll('[data-zflex-id="productReveal.productLink"]').forEach(c=>c.href=`/products/${t.slug||t.id}`))}if(n==="productCard"||n==="productCard.style"){P(r);return}document.querySelectorAll(`[data-zflex-id="${n}"]`).forEach(t=>{x(t,n,r,e)})}function f(i,e=!0){i&&(i.classList.remove("zflex-highlight-pulse"),i.offsetWidth,i.classList.add("zflex-highlight-pulse"),e&&i.scrollIntoView({behavior:"smooth",block:"center"}))}function k(){if(document.getElementById("zflex-preview-styles"))return;const i=document.createElement("style");i.id="zflex-preview-styles",i.textContent=`
      .zflex-highlight-pulse {
        outline: 4px solid var(--secondary-color, #FFE600);
        outline-offset: -4px;
        transition: outline-color 0.3s;
        animation: pulse-glimmer 2s infinite;
      }
      @keyframes pulse-glimmer {
        0% { outline-color: var(--secondary-color, #FFE600); }
        50% { outline-color: var(--primary-color, #000000); }
        100% { outline-color: var(--secondary-color, #FFE600); }
      }
    `,document.head.appendChild(i)}window.addEventListener("message",i=>{const e=i.data;if(e.source==="zflex-admin")switch(e.action){case"initData":u=!0,console.log("ðŸš€ [Pulse Preview] Initializing Data Silently...");const n=e.payload;p=n.products||[],b=n.featuredProducts||p.slice(0,4),P(),y({id:"featuredProducts"}),y({id:"catalog"}),m({id:"featuredProduct.productId",value:p[0]?.id},!0),setTimeout(()=>{u=!1,console.log("ðŸš€ [Pulse Preview] Initialization Complete. Sync Live.")},800);break;case"updateProductData":const r=e.payload;if(r.id&&r.product){const c=p.findIndex(d=>d.id===r.id);c!==-1&&(p[c]=r.product)}break;case"updateProductList":const a=e.payload;a.id==="featuredProducts.productIds"||a.id==="featuredProducts"?(a.products&&(b=a.products),y({id:"featuredProducts",products:a.products})):y(a);break;case"updatePalette":z(e.payload);break;case"updateElement":m(e.payload);break;case"updateStyle":const t=e.payload;m({id:t.property,value:t.value},!0);break;case"updateLayout":S(e.payload);break;case"injectTemplate":w(e.payload);break;case"updateVariant":const o=e.payload;o.id&&(E[o.id]=o.data),$(o);break;case"updateRepeater":A(e.payload);break;case"highlight":const s=document.querySelector(`[data-zflex-id="${e.payload.id}"]`);s&&!u&&f(s,!0);break}});function A(i){const{id:e,items:n}=i;console.log(`[Preview] Repeater update for ${e}`,n);const r=(a,t,o)=>{const s=document.getElementById(a);if(!s)return console.warn(`[Preview] Template ${a} not found`),null;const c=s.content.cloneNode(!0);c.querySelectorAll("[data-zflex-id]").forEach(g=>{const v=(g.getAttribute("data-zflex-id")||"").replace(".ID.",`.${o}.`);g.setAttribute("data-zflex-id",v);const T=v.split(".").pop(),M=t[T||""]||"";x(g,v,M,!0)});const l=c.querySelector("[data-item-index]");return l&&(l.textContent=(o+1).toString().padStart(2,"0")),c};if(e==="painPoints.items"){const a=document.querySelector('[data-zflex-section="painPoints"]'),t=a?.querySelector(".pain-points-container");if(!t)return;const s=`tpl-pain-points-${a?.getAttribute("data-variant")||"brutal"}`;t.innerHTML="",n.forEach((c,d)=>{const l=r(s,c,d);l&&t.appendChild(l)}),u||f(t)}else if(e==="features.items"){const a=document.querySelector('[data-zflex-section="features"]'),t=a?.querySelector(".container > div:not(h2)");if(!t)return;const s=`tpl-features-${a?.getAttribute("data-variant")||"zigzag"}`;t.innerHTML="",n.forEach((c,d)=>{const l=r(s,c,d);if(l){const g=l.querySelector?.("[data-zigzag]")||(l.firstElementChild?.hasAttribute("data-zigzag")?l.firstElementChild:null);g&&(d+1)%2===0&&g.classList.add("md:flex-row-reverse"),t.appendChild(l)}}),u||f(t)}else if(e==="testimonials.items"){const a=document.querySelector('[data-zflex-section="testimonials"] .flex');if(!a)return;a.innerHTML="",n.forEach((t,o)=>{const s=r("tpl-testimonials-item",t,o);s&&a.appendChild(s)}),u||f(a)}else if(e==="faq.items"){const a=document.querySelector('[data-zflex-section="faq"]'),t=a?.querySelector(".space-y-4");if(!t)return;const s=`tpl-faq-${a?.getAttribute("data-variant")||"accordion"}`;t.innerHTML="",n.forEach((c,d)=>{const l=r(s,c,d);l&&t.appendChild(l)}),u||f(t)}else if(e==="howItWorks.steps"){const a=document.querySelector('[data-zflex-section="howItWorks"] .relative.space-y-16');if(!a)return;const t=a.querySelector(".bg-primary");a.innerHTML="",t&&a.appendChild(t),n.forEach((o,s)=>{const c=r("tpl-how-it-works-step",o,s);if(c){const d=c.querySelector?.("[data-step-content]")||c.querySelector("[data-step-content]");d&&((s+1)%2!==0?d.classList.add("md:pr-24","md:text-right"):d.classList.add("md:pl-24","md:order-last")),a.appendChild(c)}}),u||f(a)}}window.parent!==window&&(console.log("âš¡ [Pulse Preview] Sending READY signal to Vandal..."),window.parent.postMessage({source:"zflex-preview",action:"ready"},"*"))}export{B as initPreviewMode};
