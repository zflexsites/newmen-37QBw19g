import{g as V,f as _,h as z,i as j,j as G}from"./analytics-Dfyu_B3T.js";import{g as Z,d as Q,n as J}from"./router-DNvg7vsX.js";function F(){try{const e=document.getElementById("zflex-data")||document.querySelector(".zflex-fragment-data");return!e||!e.textContent?(console.warn("[Checkout] Tunnel de data est vide ou introuvable."),{}):JSON.parse(e.textContent)}catch(e){return console.error("[Checkout] Erreur de parsing du tunnel de data:",e),{}}}function K(){return Math.random().toString(36).slice(2,9)}function Y(e){return`${e}-${Date.now()}-${K()}`}function W(e){if(e){if(typeof e.transactionStatus=="string")return e.transactionStatus;if(e.result&&typeof e.result.transactionStatus=="string")return e.result.transactionStatus;if(e.data&&typeof e.data.transactionStatus=="string")return e.data.transactionStatus;if(typeof e.status=="string")return e.status}}function X(e){if(e)return e.error||e.message||e.result?.error||e.result?.message||e.data?.error}function ee(e){const y=document.getElementById("summary-items-list"),d=document.getElementById("summary-subtotal"),N=document.getElementById("summary-total");if(!y||!d||!N)return;if(!e||e.length===0){y.innerHTML='<p class="font-mono text-xs text-muted">Votre drop est vide.</p>',d.innerHTML="--.--",N.innerHTML="--.--";return}y.innerHTML="";let C=0,S="USD";e.forEach(h=>{const m=h.price?.amount||0;S=h.price?.currency||"USD";const p=h.quantity||1;C+=m*p;const v=document.createElement("div");v.className="flex justify-between items-end border-b-2 border-dashed border-primary/20 pb-4",v.innerHTML=`
        <div class="flex flex-col">
            <span class="font-mono text-[10px] text-muted">UNIT x${p}</span>
            <span class="font-black uppercase text-sm">${h.title||"ITEM"}</span>
        </div>
        <span class="font-bold font-mono text-sm">${(m*p).toFixed(2)} ${S}</span>
    `,y.appendChild(v)});const R=`${C.toFixed(2)} ${S}`;d.innerHTML=R,N.innerHTML=R}function re(){const e=document.getElementById("checkout-form");if(!e)return;const y=document.getElementById("checkout-error");let d=null;const N=async n=>{const s=localStorage.getItem("zflex_prospectId");if(!(!s||!n))try{const o=await V(n,s);o.success&&o.data&&_.dispatchEvent(new CustomEvent("dialog:show",{detail:{title:"IDENTIFICATION POSITIVE",message:"Signal reconnu. Récupération des données du profil précédent ?",confirmText:"CHARGER DONNÉES",cancelText:"IGNORER",variant:"info",onConfirm:()=>{const t=e.elements;t.name&&(t.name.value=o.data?.name||""),t.email&&(t.email.value=o.data?.email||""),t.phone&&(t.phone.value=o.data?.phone||""),t.address&&(t.address.value=o.data?.address||""),t.notes&&(t.notes.value=o.data?.notes||"")}}}))}catch(o){console.warn("[Pulse] Prospect fetch failed",o),String(o?.message||"").includes("Aucune information")&&localStorage.removeItem("zflex_prospectId")}},C=F().storeId;if(!C){console.error("[Checkout] Erreur critique : ID du store non trouvé à l'initialisation.");const n=document.querySelector(".space-y-16");n&&(n.innerHTML='<div class="p-6 bg-red-50 border-2 border-red-500 font-bold text-red-600 uppercase">Erreur Système : Store ID manquant.</div>');return}N(C);const S=Z()||[];ee(S);const R=document.getElementById("step-address"),h=document.getElementById("step-payment"),m=document.getElementById("continue-to-payment-btn"),p=document.getElementById("progress-bar"),v=document.getElementById("checkout-title"),I=document.getElementById("submit-order-btn"),L=document.getElementById("payment-phone"),w=document.getElementById("operator-logo-container"),M=document.getElementById("selected-payment-method"),x=document.getElementById("payment-instructions"),l=document.getElementById("use-geolocation-btn"),D=document.getElementById("address");if(!m||!I||!y){console.error("[Checkout] Éléments DOM critiques manquants (boutons ou erreur).");return}const f=n=>{y.textContent=n,y.classList.remove("hidden")},U=()=>{y.classList.add("hidden")},A=async(n,s,o=null)=>{const t=(n||"").toUpperCase(),r=I.querySelector(".btn-spinner"),a=I.querySelector(".btn-text");if(t==="SUCCESS"||t==="SUCCEEDED"||t==="COMPLETED"){r&&r.classList.add("hidden"),a&&(a.textContent="SIGNAL CONFIRMÉ"),p&&(p.style.width="100%"),setTimeout(()=>{Q();try{J(`/order-success/?id=${encodeURIComponent(d||"")}`)}catch{window.location.href=`/order-success/?id=${encodeURIComponent(d||"")}`}},900);return}if(t==="PENDING"){r&&r.classList.add("hidden"),I.disabled=!1,a&&(a.textContent="EN ATTENTE..."),p&&(p.style.width="95%"),f(s||"Transaction en attente. Confirmez sur votre mobile.");return}r&&r.classList.add("hidden"),I.disabled=!1,a&&(a.textContent="AUTORISER LE DROP"),f(s||"Échec de transaction.")},B=async()=>{U();const n=e.elements,s=n.name.value.trim(),o=n.email.value.trim(),t=n.phone.value.trim(),r=n.address.value.trim();if(!s||!o||!t||!r){f("DONNÉES MANQUANTES. VEUILLEZ COMPLÉTER LE FORMULAIRE.");return}m.disabled=!0;const a=m.innerHTML;m.textContent="ENREGISTREMENT...";try{const i={name:s,email:o,phone:t,address:r,notes:n.notes?.value.trim()||""},b=S.reduce((E,O)=>E+O.price.amount*O.quantity,0),g={customer:i,items:S,total:b,currency:S[0]?.price.currency||"EUR"},c=await z(g,C);if(!c.success||!c.orderId)throw new Error(c.error||"Échec initialisation commande.");d=c.orderId,c.readableId&&localStorage.setItem(`zflex_readable_${d}`,c.readableId),c.prospectId&&localStorage.setItem("zflex_prospectId",c.prospectId),R&&R.classList.add("hidden"),h&&h.classList.remove("hidden"),p&&(p.style.width="60%"),v&&(v.textContent="Transaction Mobile."),window.scrollTo({top:0,behavior:"smooth"})}catch(i){f(i.message||"Erreur système."),m.disabled=!1,m.innerHTML=a}},k=async n=>{if(n.preventDefault(),U(),!d){f("ID COMMANDE MANQUANT. RAFRAÎCHISSEZ.");return}const s=M?.value,t=(L?.value||"").replace(/\D/g,"");if(!s||!t||t.length<9){f("NUMÉRO MOBILE INVALIDE (OPÉRATEUR NON DÉTECTÉ).");return}I.disabled=!0;const r=I.querySelector(".btn-text"),a=I.querySelector(".btn-spinner");r&&(r.textContent="INITIATION..."),a&&a.classList.remove("hidden");const i=`zflex_txref_${d}`;let b=localStorage.getItem(i);if(!b){b=Y(d);try{localStorage.setItem(i,b)}catch{}}try{const g=F().storeId;if(!g)throw new Error("ID du store manquant.");const c=await j(d,g,s,`+243${t}`,b),E=X(c),O=W(c);if(E)if(String(E).toLowerCase().includes("transactionreference already exists")||String(E).toLowerCase().includes("transactionreference")&&String(E).toLowerCase().includes("exists"))try{const T=await G(d,g),u=T,P=u.transactionStatus||u.result?.transactionStatus||u.status||u.data?.transactionStatus||u.statusText||(u.success?u.result?.transactionStatus:void 0);await A(P,"Transaction existante. Vérification en cours.",T);return}catch{f("Vérification transaction existante impossible."),a&&a.classList.add("hidden"),I.disabled=!1,r&&(r.textContent="AUTORISER LE DROP");return}else throw new Error(String(E));if(O){if(O.toUpperCase()==="PENDING"){await A("PENDING","SIGNAL ENVOYÉ. CONFIRMEZ SUR VOTRE TERMINAL MOBILE.");return}else if(["SUCCESS","SUCCEEDED","COMPLETED"].includes(O.toUpperCase())){await A("SUCCESS","PAIEMENT CONFIRMÉ.");return}}try{const T=await G(d,g),u=T,P=u.transactionStatus||u.result?.transactionStatus||u.status||u.data?.transactionStatus,q=u.message||"";await A(P,q,T)}catch{throw new Error("Statut inconnu.")}}catch(g){const c=g?.message||String(g);let E="ÉCHEC DE L'INITIATION.";c.includes("transactionReference already exists")?E="TENTATIVE EN COURS...":(c.includes("aucun opérateur")||c.toLowerCase().includes("operator"))&&(E="OPÉRATEUR NON SUPPORTÉ."),f(E),a&&a.classList.add("hidden"),I.disabled=!1,r&&(r.textContent="AUTORISER LE DROP")}},H=()=>{if(!L)return;const s=(L.value||"").replace(/\D/g,"").substring(0,2),o=["81","82","83"],t=["80","84","85","89"],r=["97","99"],a=["90"];let i="";o.includes(s)&&(i="MPESA"),t.includes(s)&&(i="ORANGE"),r.includes(s)&&(i="AIRTEL"),a.includes(s)&&(i="AFRICELL"),w&&(w.innerHTML=""),i&&M&&x?(M.value=i,w&&(w.innerHTML=i),x.innerHTML=`<p>Opérateur <strong>${i}</strong> détecté. Signal prêt.</p>`,x.classList.add("bg-primary/10","border-primary")):M&&x&&(M.value="",x.innerHTML="<p>En attente du signal opérateur...</p>",x.classList.remove("bg-primary/10","border-primary"))},$=()=>{if(!navigator.geolocation){f("GÉOLOCALISATION NON SUPPORTÉE.");return}l&&(l.disabled=!0,l.classList.add("animate-ping"),navigator.geolocation.getCurrentPosition(async n=>{console.log("[Pulse] Position reçue:",n);const{latitude:s,longitude:o}=n.coords;try{const r=await(await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${s}&lon=${o}`)).json();if(r&&r.display_name&&D)D.value=r.display_name;else throw new Error("Adresse non trouvée.")}catch{f("IMPOSSIBLE DE LOCALISER.")}finally{l&&(l.disabled=!1,l.classList.remove("animate-ping"))}},n=>{console.warn("[Pulse] Erreur Géoloc:",n),f("ERREUR GÉOLOC ("+n.code+") - TIMEOUT: 20s"),l&&(l.disabled=!1,l.classList.remove("animate-ping"))},{timeout:2e4,enableHighAccuracy:!0,maximumAge:0}))};return m.addEventListener("click",B),L&&L.addEventListener("input",H),l&&l.addEventListener("click",$),e.addEventListener("submit",k),console.log("[Pulse] Checkout Module V2.0 Initialized."),{destroy:()=>{m.removeEventListener("click",B),L&&L.removeEventListener("input",H),l&&l.removeEventListener("click",$),e.removeEventListener("submit",k),console.log("[Pulse] Checkout Module Destroyed.")}}}export{re as initCheckout};
