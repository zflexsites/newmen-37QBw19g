import{c as P,s as U,a as _}from"./analytics-Dfyu_B3T.js";import{d as me,b as ye,e as ge}from"./analytics-Dfyu_B3T.js";import{g as z,r as B,a as K}from"./router-DNvg7vsX.js";import{c as he,b as ve}from"./router-DNvg7vsX.js";import{d as xe}from"./dialog-BU67H1bK.js";let u=!1,y=[],L=null,C=null;const $=1440*60*1e3,v=e=>`stacy_conv_${e}`,E=e=>`stacy_history_${e}`,Y=new Set(["searchProducts","manageCart","getContextDelta","redirectToVerifyPage"]);function b(){try{const t=document.getElementById("zflex-data")?.textContent;return t?JSON.parse(t):{}}catch(e){return console.error("[Stacy] Erreur de parsing des donn√©es de la page",e),{}}}async function J(){if(C)return C;try{const e=await fetch("/api/search-index.json");if(!e.ok)throw new Error(`R√©ponse r√©seau non OK: ${e.statusText}`);return C=await e.json(),C||[]}catch(e){return console.error("[Stacy] Impossible de charger l'index de recherche:",e),[]}}function m(e){return String(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function G(e){try{const t=String(e).trim();if(/^(https?:|mailto:)/i.test(t))return t}catch{}return"#"}function k(e){let t=m(e);return t=t.replace(/```([\s\S]*?)```/g,(r,n)=>`<pre class="stacy-code"><code>${m(n)}</code></pre>`),t=t.replace(/`([^`]+)`/g,(r,n)=>`<code class="stacy-inline-code">${m(n)}</code>`),t=t.replace(/\[([^\]]+)\]\(([^)]+)\)/g,(r,n,a)=>`<a href="${G(a)}" target="_blank" rel="noopener noreferrer" class="zflex-link">${m(n)}</a>`),t=t.replace(/\*\*([^*]+)\*\*/g,(r,n)=>`<strong>${m(n)}</strong>`),t=t.replace(/\*([^*]+)\*/g,(r,n)=>`<em>${m(n)}</em>`),t=t.replace(/\r?\n/g,"<br>"),t}function O(e){try{let t=function(c){const l=Array.from(c.childNodes);for(const o of l)if(o.nodeType===Node.ELEMENT_NODE){const i=o;if(s.has(i.tagName)){if(i.tagName==="A"){const d=i.getAttribute("href")||"";/^(https?:|mailto:)/i.test(d.trim())?(i.setAttribute("target","_blank"),i.setAttribute("rel","noopener noreferrer")):i.removeAttribute("href")}else{const d=Array.from(i.attributes);for(const S of d)i.removeAttribute(S.name)}t(i)}else{const d=document.createDocumentFragment();for(;i.firstChild;)d.appendChild(i.firstChild);c.replaceChild(d,i),t(c);continue}}else o.nodeType!==Node.TEXT_NODE&&c.removeChild(o)};const a=new DOMParser().parseFromString(`<div>${e}</div>`,"text/html").body.firstChild;if(!a)return"";const s=new Set(["A","UL","OL","LI","STRONG","EM","CODE","PRE","BR","P"]);return t(a),a.innerHTML}catch(t){return console.warn("[Stacy] sanitizeHtml failed, falling back to escaped text",t),m(e)}}function H(e,t,r={rawHtml:!1}){const n=document.querySelector("[data-stacy-messages]");if(!n)return;const a=document.createElement("div");a.className="flex flex-col p-1 my-1 max-w-[85%] text-sm break-words";const s=document.createElement("div");s.className="p-2 rounded-lg";const c=document.createElement("div");c.className="text-xs mb-1 truncate";const l=typeof e.text=="string"?e.text:JSON.stringify(e.text??"");t==="user"?(a.style.alignSelf="flex-end",s.classList.add("bg-primary/20","self-end"),c.textContent="Vous",c.style.textAlign="right",s.textContent=l):(a.style.alignSelf="flex-start",c.textContent="Stacy",c.style.color="var(--text-muted-color)",s.classList.add("self-start"),s.style.backgroundColor="var(--chat-response-bg-color)",s.style.color="var(--text-color)",r.rawHtml?s.innerHTML=O(l):s.innerHTML=k(l)),a.appendChild(c),a.appendChild(s),n.appendChild(a),n.scrollTop=n.scrollHeight}function V(){const e=document.querySelector("[data-stacy-messages]");e&&(e.innerHTML="",y.forEach(t=>H(t,t.role,{rawHtml:!0})))}async function W(){const e=b().storeId;if(!e)return;const t=localStorage.getItem(v(e)),r=t?JSON.parse(t):null;if(r&&Date.now()-r.createdAt<$){const n=localStorage.getItem(E(r.convId));y=n?JSON.parse(n):[],V()}else await F(e)}function h(e){localStorage.setItem(E(e),JSON.stringify(y))}function I(e,t){const r={role:t,text:e,ts:Date.now()};y.push(r),H(r,t,{rawHtml:!0})}function X(){const e=document.querySelector("[data-stacy-messages]");if(!e)return null;const t=document.createElement("div");return t.className="p-2 my-1 rounded-lg max-w-[60%] self-start text-sm break-words stacy-typing",t.innerHTML='<div class="typing-indicator"><span></span><span></span><span></span></div>',e.appendChild(t),e.scrollTop=e.scrollHeight,t}function Q(e,t={rawHtml:!1}){const r=document.querySelector("[data-stacy-messages]");if(!r)return null;const n=document.createElement("div");n.className="flex flex-col p-1 my-1 max-w-[85%] text-sm break-words model-message-wrapper";const a=document.createElement("div");a.className="text-xs mb-1 truncate",a.textContent="Stacy",a.style.color="var(--muted-text-color)";const s=document.createElement("div");s.className="p-2 rounded-lg self-start model-message-bubble";const c=e;t.rawHtml?s.innerHTML=O(c):s.innerHTML=k(c);const l=document.createElement("div");return l.className="stacy-partial-loader",l.style.marginTop="6px",l.innerHTML='<div class="typing-indicator"><span></span><span></span><span></span></div>',l.style.display="none",n.appendChild(a),n.appendChild(s),n.appendChild(l),r.appendChild(n),r.scrollTop=r.scrollHeight,{wrapper:n,bubble:s,loader:l}}function A(e){!e||!e.loader||(e.loader.style.display="",e.wrapper.scrollIntoView({behavior:"smooth",block:"end"}))}function w(e){!e||!e.loader||(e.loader.style.display="none")}function g(e,t,r={rawHtml:!1}){!e||!e.bubble||(r.rawHtml?e.bubble.innerHTML=O(t):e.bubble.innerHTML=k(t),w(e))}async function R(e,t=12e3){let r;return Promise.race([e,new Promise((n,a)=>r=setTimeout(()=>a(new Error("timeout")),t))]).finally(()=>clearTimeout(r))}async function j(e){const t=v(e);try{const r=localStorage.getItem(t);if(r){const a=JSON.parse(r);if(Date.now()-(a.createdAt||0)<=$)return a.convId}const n=await P(e);if(!n?.convId)throw new Error("createConversation n'a pas retourn√© de convId");return localStorage.setItem(t,JSON.stringify({convId:n.convId,createdAt:Date.now()})),localStorage.removeItem(E(n.convId)),n.convId}catch(r){throw console.error("[Stacy] Erreur getOrCreateConvId",r),r}}async function F(e){try{const t=localStorage.getItem(v(e)),r=t?JSON.parse(t):null;r&&localStorage.removeItem(E(r.convId)),localStorage.removeItem(v(e)),y=[],V();const n=await P(e);if(n?.convId){localStorage.setItem(v(e),JSON.stringify({convId:n.convId,createdAt:Date.now()}));const a=n.greeting||"Salut ! C'est Stacy, ton assistante shopping. Pr√™t(e) √† trouver des p√©pites ? ‚ú®";I(a,"model"),h(n.convId)}}catch(t){console.error("[Stacy] resetConversation error",t),H({text:"Impossible de r√©initialiser la conversation."},"model")}}async function Z(e){e.preventDefault();const r=e.target.querySelector("[data-stacy-input]");if(!r)return;const n=r.value.trim();if(!n)return;I(n,"user"),r.value="";const a=b().storeId;if(a){const s=await j(a);h(s)}await ee(n)}async function ee(e){const t=document.querySelector("[data-stacy-input]");t&&(t.disabled=!0);const r=X();try{const n=b().storeId;if(!n)throw new Error("storeId introuvable");const a=await j(n),s=await U(n,a,e);if(r&&r.remove(),s.newConvId&&localStorage.setItem(v(n),JSON.stringify({convId:s.newConvId,createdAt:Date.now()})),s.functionCall){const o=Q("Un instant, je r√©fl√©chis... ü§î",{rawHtml:!1});if(A(o),s.needsUserInput){w(o);const d=s.answer||"J'ai besoin d'une information suppl√©mentaire.";if(g(o,d,{rawHtml:!1}),o&&o.wrapper){const S=o.wrapper,p=document.createElement("input");p.type="text",p.placeholder="Entrez le num√©ro de commande...",p.className="stacy-inline-input";const f=document.createElement("button");f.textContent="Envoyer",f.className="stacy-inline-btn";const x=document.createElement("div");x.style.marginTop="8px",x.appendChild(p),x.appendChild(f),S.appendChild(x),p.focus();const M=async()=>{const T=p.value.trim();if(T){x.remove(),A(o);try{const q=s.functionCall?.name||"unknown",D=(await _(n,a,{name:q,result:{orderId:T}}))?.answer??"D√©sol√©, erreur lors de la finalisation.";g(o,D,{rawHtml:!0}),y.push({role:"model",text:D}),h(a)}catch{w(o),g(o,"Erreur lors de l'envoi de l'information. R√©essaie.",{rawHtml:!1})}}};f.addEventListener("click",M),p.addEventListener("keydown",T=>{T.key==="Enter"&&M()})}return}const i=s.functionCall.name||"unknown";if(Y.has(i))try{const d=await R(te(s.functionCall),12e3),S=d.result??d,f=(await R(_(n,a,{name:i,result:S}),2e4))?.answer??"D√©sol√©, erreur lors de la finalisation.";f.includes("__tool_result")?o?.wrapper.remove():(g(o,f,{rawHtml:!0}),y.push({role:"model",text:f})),h(a);return}catch{w(o),g(o,"Impossible d'ex√©cuter l'action c√¥t√© client.",{rawHtml:!1});return}if(s.answer){w(o),g(o,s.answer,{rawHtml:!0}),y.push({role:"model",text:s.answer}),h(a);return}w(o),g(o,"Action en attente...",{rawHtml:!1});return}const c=s?.answer??"D√©sol√©, une erreur est survenue.";I(c,"model"),h(a)}catch(n){r&&r.remove(),console.error("[Stacy] Erreur processStacyRequest",n),I("Oups, quelque chose s'est mal pass√©. Veuillez r√©essayer.","model")}finally{t&&(t.disabled=!1,u&&t.focus())}}async function te(e){const t=e.name||e.functionName||e.fn||"unknown",r=e.args||e.arguments||e.params||{};switch(t){case"searchProducts":{const n=String(r.keywords||r.q||""),a=await ne(n);return{success:!!a.success,action:"searchProducts",result:a}}case"manageCart":{const n=await re(r);return{success:!!n.success,action:"manageCart",result:n}}case"redirectToVerifyPage":{const n=await se();return{success:!!n.success,action:"redirectToVerifyPage",result:n}}case"getContextDelta":return{success:!0,action:"getContextDelta",result:ae()};default:return console.warn(`[Stacy] functionCall non g√©r√© c√¥t√© client: ${t}`),{success:!1,action:String(t),result:{displayText:`Action demand√©e inconnue c√¥t√© client: ${String(t)}`,reason:"unknown"}}}}async function ne(e){const t=await J(),r=String(e||"").toLowerCase().split(" ").filter(a=>a),n=t.filter(a=>r.every(s=>a.title.toLowerCase().includes(s)));return n.length>0?{success:!0,products:n.slice(0,3).map(s=>({id:s.id,title:s.title,price:s.price,shortDescription:s.shortDescription,url:s.url})),displayText:`J'ai trouv√© ${n.length} produit(s).`}:{success:!1,displayText:`D√©sol√©, je n'ai trouv√© aucun produit pour "${m(String(e))}".`}}async function re(e){const t=e.action,r=e.productId,n=e.quantity||1;switch(t){case"add":{if(!r)return{success:!1,displayText:"Je ne sais pas quel produit ajouter."};const s=(await J()).find(c=>c.id===r);return s?(K(s,n),{success:!0,displayText:`J'ai ajout√© ${n}x "${s.title}" √† votre panier.`}):{success:!1,displayText:`Je n'ai pas trouv√© le produit avec l'ID ${r}.`}}case"remove":return r?(B(r),{success:!0,displayText:"L'article a √©t√© retir√© de votre panier."}):{success:!1,displayText:"Je ne sais pas quel produit retirer."};case"list":default:{const a=z();return!a||a.length===0?{success:!0,cart:[],displayText:"Votre panier est actuellement vide."}:{success:!0,cart:a,displayText:`Votre panier contient ${a.length} article(s).`}}}}function ae(){return{pageType:document.querySelector("#app-content main")?.dataset.pageType||"unknown",pageTitle:document.title,url:window.location.href,productContext:b().product||null}}async function se(){if(L)try{return L.navigateTo("/verify/"),N(),{success:!0,displayText:"[Action Syst√®me] Redirection vers /verify/ effectu√©e."}}catch(e){return console.warn("[Stacy] Router navigation failed",e),{success:!1,displayText:"[Action Syst√®me] Routeur non disponible."}}else return{success:!1,displayText:"[Action Syst√®me] Routeur non disponible."}}function N(){const e=document.querySelector("[data-stacy-window]"),t=document.querySelector("[data-stacy-fab-button]");if(!e||!t)return;u=!u,e.classList.toggle("is-open",u),e.classList.toggle("hidden",!u),t.setAttribute("aria-expanded",String(u));const r=t.querySelector('[data-stacy-icon="chat"]'),n=t.querySelector('[data-stacy-icon="close"]');if(r&&n&&(r.style.opacity=u?"0":"1",n.style.opacity=u?"1":"0"),u){W();const a=document.querySelector("[data-stacy-input]");a&&setTimeout(()=>a.focus(),50)}}function oe(){const e=document.querySelector("[data-stacy-fab-button]");e&&e.addEventListener("click",N);const t=document.querySelector("[data-stacy-form]");if(t){t.addEventListener("submit",Z);const n=t.querySelector("[data-stacy-input]");n&&n.addEventListener("keydown",a=>{const s=a;s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),t.requestSubmit())})}document.addEventListener("keydown",n=>{n.key==="Escape"&&u&&N()});const r=document.querySelector("[data-stacy-delete]");r&&r.addEventListener("click",async()=>{try{const n=b().storeId;if(!n)throw new Error("storeId introuvable");await F(n)}catch(n){console.error("[Stacy] delete conv failed",n),H({text:"Impossible de supprimer la conversation."},"model")}})}function ce(e){document.querySelector("[data-stacy-fab]")&&(L=e,oe(),console.log("[Stacy] Module V7.5 (Brain Upgrade) initialis√©."))}const ue=Object.freeze(Object.defineProperty({__proto__:null,initStacy:ce},Symbol.toStringTag,{value:"Module"}));export{me as analytics,ye as api,he as cart,xe as dialog,ge as eventBus,ve as router,ue as stacy};
