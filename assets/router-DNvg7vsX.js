import{k as j,f as q,t as k}from"./analytics-Dfyu_B3T.js";const R="zflex_cart";function m(){const e=localStorage.getItem(R);return e?JSON.parse(e):[]}function g(e){localStorage.setItem(R,JSON.stringify(e)),window.dispatchEvent(new CustomEvent("cartUpdated"))}function B(e,a=1){const t=m(),n=t.find(o=>o.id===e.id);n?n.quantity+=a:t.push({...e,quantity:a}),g(t)}function P(e,a){let t=m();const n=t.find(o=>o.id===e);n&&(a>0?n.quantity=a:t=t.filter(o=>o.id!==e),g(t))}function $(e){const a=m().filter(t=>t.id!==e);g(a)}function z(){g([])}function T(){const e=document.getElementById("cart-count");if(!e)return;const t=m().reduce((n,o)=>n+o.quantity,0);e.textContent=String(t),e.style.display=t>0?"flex":"none",t>0&&(e.classList.add("updated"),setTimeout(()=>{e.classList.remove("updated")},300))}function M(){if(!document.querySelector('[data-page-type="cart"]'))return;const a=document.getElementById("cart-items-list"),t=document.getElementById("cart-subtotal"),n=document.getElementById("cart-total"),o=document.getElementById("cart-empty-state"),r=document.getElementById("cart-content");if(!a||!t||!n||!o||!r){console.error("[Cart] Erreur critique: DOM manquant dans cart.njk.");return}const i=m(),c=document.getElementById("cart-item-template");if(!c){console.error("[Cart] Erreur critique: le template #cart-item-template est manquant.");return}if(i.length===0){o.classList.remove("hidden"),r.classList.add("hidden");return}o.classList.add("hidden"),r.classList.remove("hidden"),a.innerHTML="";let u={};i.forEach(s=>{const p=Number(s.price?.amount||0),l=s.price?.currency||"EUR",h=Number(s.quantity||1),d=c.content.cloneNode(!0),b=d.querySelector('[data-template-field="image"]');b&&(b.src=s.coverImage||"");const C=d.querySelector('[data-template-field="title"]');C&&(C.textContent=s.title||"Produit sans nom");const x=d.querySelector('[data-template-field="url"]');x&&(x.href=s.url||"#");const S=d.querySelector('[data-template-field="price"]');S&&(S.textContent=`${p.toFixed(2)} ${l}`);const f=d.querySelector('[data-template-field="quantity"]');f&&(f.value=String(h),f.addEventListener("change",()=>P(s.id,parseInt(f.value,10))));const L=d.querySelector('[data-template-field="total"]');L&&(L.textContent=`${(p*h).toFixed(2)} ${l}`);const I=d.querySelector('[data-template-field="remove-btn"]');I&&I.addEventListener("click",()=>$(s.id)),a.appendChild(d),u[l]||(u[l]=0),u[l]+=p*h}),t.innerHTML="",n.innerHTML="",Object.entries(u).forEach(([s,p])=>{const l=`${Number(p).toFixed(2)} ${s}`;t.innerHTML+=`<div>${l}</div>`,n.innerHTML+=`<div>${l}</div>`})}function A(){document.querySelector('[data-page-type="cart"]')&&(console.log("[Cart] Initialisation de la page panier..."),M())}async function D(){document.querySelectorAll("#add-to-cart-btn").forEach(a=>{const t=a;t.dataset.listenerAttached||(t.addEventListener("click",async()=>{t.disabled=!0;try{const n=document.getElementById("zflex-data");if(!n)throw new Error("Erreur critique: Tunnel de data #zflex-data manquant.");const o=JSON.parse(n.textContent||"{}");if(!o?.product)throw new Error("Données du produit non trouvées dans le tunnel de data.");const i=(await j()).find(c=>c.id===o.product.id);if(i)B(i),q.dispatchEvent(new CustomEvent("dialog:show",{detail:{title:"Ajouté au panier !",message:`${i.title.trim()} a bien été ajouté.`,variant:"success"}}));else throw new Error("Produit introuvable dans l'index de recherche.")}catch(n){console.error("Erreur lors de l'ajout au panier:",n),q.dispatchEvent(new CustomEvent("dialog:show",{detail:{title:"Erreur",message:n.message||"Impossible d'ajouter ce produit au panier.",variant:"error"}}))}finally{t.disabled=!1}}),t.dataset.listenerAttached="true")})}function N(){T(),window.addEventListener("cartUpdated",()=>{T(),M()}),console.log("[Cart] Module global initialisé.")}const F=Object.freeze(Object.defineProperty({__proto__:null,addItem:B,clearCart:z,getCart:m,initAddToCartButton:D,initCartPage:A,initGlobalCart:N,removeItem:$,updateItemQuantity:P},Symbol.toStringTag,{value:"Module"}));let y=!1;function H(){_(),window.addEventListener("popstate",()=>w());try{k()}catch(e){console.warn("[Router] Le tracking de la page initiale a échoué:",e)}console.log("[Router] Initialisé en mode GATEKEEPER.")}function E(e){if(y)return;const t=e.target.closest("a.zflex-link");if(!t||t.target==="_blank")return;const n=new URL(t.href);if(n.hash&&n.pathname===window.location.pathname){e.preventDefault();const r=document.querySelector(n.hash);r&&r.scrollIntoView({behavior:"smooth",block:"start"});return}if(n.origin!==window.location.origin)return;e.preventDefault(),e.preventDefault();const o=n.pathname+n.search+n.hash;O(o)}function _(){document.body.addEventListener("touchstart",()=>{y=!1},{passive:!0}),document.body.addEventListener("touchmove",()=>{y=!0},{passive:!0}),document.body.addEventListener("click",E),document.body.addEventListener("touchend",E)}function O(e){e!==window.location.pathname&&(history.pushState({},"",e),w())}async function w(){const e=window.location.pathname;console.log(`[Router] Navigation détectée vers : ${e}`);const a=e==="/"||e===""?"/content/home.html":`/content${e.replace(/\/$/,"")}.html`,t=document.getElementById("app-content"),n=document.getElementById("router-loader");if(!t){console.error("ERREUR CRITIQUE: Conteneur #app-content introuvable.");return}n&&n.classList.remove("hidden"),t.style.opacity="0.5",t.style.transition="opacity 0.3s ease-in-out";try{const o=await fetch(a);if(!o.ok){if(o.status===404){const c=await(await fetch("/content/404.html")).text();v(c,"404 - Page non trouvée");return}throw new Error(`Erreur serveur: ${o.statusText}`)}const r=await o.text();v(r)}catch(o){const r=o instanceof Error?o.message:String(o);console.error("Erreur de routage critique:",o),t.innerHTML=`
      <div class="text-center py-20">
        <h1 class="text-2xl font-bold">Erreur de chargement</h1>
        <p class="text-gray-600 mt-2">${r}</p>
        <button onclick="window.location.reload()" class="mt-4 bg-primary text-white font-bold py-2 px-4 rounded">Recharger la page</button>
      </div>
    `}finally{if(n&&n.classList.add("hidden"),document.body.contains(t)&&(t.style.opacity="1"),window.location.hash){const o=window.location.hash;setTimeout(()=>{const r=document.querySelector(o);r&&r.scrollIntoView({behavior:"smooth",block:"start"})},100)}else window.scrollTo(0,0)}}function v(e,a=null){const t=document.getElementById("app-content"),n=document.getElementById("zflex-data"),i=new DOMParser().parseFromString(e,"text/html").querySelector("main");if(i&&n&&t){const c=i.querySelector(".zflex-fragment-data");c&&(n.textContent=c.textContent,c.remove()),document.title=a||i.dataset.pageTitle||document.title,t.innerHTML="",t.appendChild(i),window.dispatchEvent(new CustomEvent("zflex:page-loaded",{detail:{path:window.location.pathname}}));try{k()}catch(u){console.warn("[Router] Le tracking de la nouvelle page a échoué:",u)}}else console.error("Erreur critique: <main> ou #zflex-data manquant.")}const G=Object.freeze(Object.defineProperty({__proto__:null,bindEventListeners:_,handleLinkClick:E,handleLocationChange:w,initRouter:H,navigateTo:O,updatePageContent:v},Symbol.toStringTag,{value:"Module"}));export{B as a,G as b,F as c,z as d,m as g,O as n,$ as r};
