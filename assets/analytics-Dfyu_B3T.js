function S(){const e=document.getElementById("zflex-data");if(!e||!e.textContent)return console.warn("[Core/API] Tunnel de data #zflex-data est vide ou introuvable."),{};try{return JSON.parse(e.textContent)}catch(t){return console.error("[Core/API] Erreur de parsing du tunnel de data #zflex-data:",t),{}}}async function a(e,t){const r=S().apiEndpoints?.[e];if(!r)throw new Error(`Endpoint API pour "${e}" non trouvé. Vérifiez la configuration du builder.`);try{const o=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),c=await o.json();if(!o.ok){const I=c.error||`Erreur ${o.status}`;throw new Error(I)}return c}catch(o){throw console.error(`[API] Erreur pour "${e}":`,o),new Error("La communication avec nos services a échoué. Veuillez réessayer.")}}function b(e,t={}){return a("createConv",{storeId:e,context:t})}function C(e,t,n,r){return a("stacy",{storeId:e,convId:t,message:n,contextDelta:r})}function O(e,t,n){return a("continueConv",{storeId:e,convId:t,functionCallResult:n})}function A(e,t,n){return a("resumeConv",{storeId:e,convId:t,keepMessagesPreview:n})}function x(e,t){return a("createOrder",{...e,storeId:t})}function P(e,t){return a("getOrderDetails",{orderId:e,storeId:t})}function k(e,t,n,r,o){return a("initiatePayment",{orderId:e,storeId:t,paymentMethod:n,paymentPhone:r,transactionReference:o})}function T(e,t){return a("getOrderStatusApi",{orderId:e,storeId:t})}function z(e,t){return a("getProspectInfo",{storeId:e,prospectId:t})}function B(e,t){return a("subscribeToNewsletter",{email:e,storeId:t})}function D(e,t){return a("submitReview",{...e,storeId:t})}function v(e,t){return a("trackEvent",{storeId:e,events:t})}let u=null;async function j(){if(u)return u;try{const e=await fetch("/api/search-index.json");if(!e.ok)throw new Error(`Erreur réseau: ${e.statusText}`);return u=await e.json(),u||[]}catch(e){return console.error("[Core/API] Impossible de charger l'index des produits:",e),[]}}const H=Object.freeze(Object.defineProperty({__proto__:null,continueConversation:O,createConversation:b,createOrder:x,fetchProductIndex:j,getOrderDetails:P,getOrderStatus:T,getProspectInfo:z,initiatePayment:k,resumeConversation:A,stacyMessage:C,submitReview:D,subscribeToNewsletter:B,trackEvent:v},Symbol.toStringTag,{value:"Module"})),g=window.zflexEventBus||new EventTarget;window.zflexEventBus=g;const K=Object.freeze(Object.defineProperty({__proto__:null,eventBus:g},Symbol.toStringTag,{value:"Module"})),w="zflex_analytics_queue_v1",M=1e4,L=50,N=3,J=150;let s=[],l=!1,d=null,y=0;function h(){try{const e=document.getElementById("zflex-data");return!e||!e.textContent?{}:JSON.parse(e.textContent)}catch{return{}}}function R(){try{const e=localStorage.getItem(w);e&&(s=JSON.parse(e))}catch(e){console.warn("[Analytics] Load queue failed.",e),s=[]}}function p(){try{localStorage.setItem(w,JSON.stringify(s))}catch(e){console.warn("[Analytics] Persist queue failed.",e)}}function $(e,t={}){const n=h()||{},r=document.querySelector("main");return{type:e,payload:t,storeId:n.storeId||null,context:{pageType:r?.dataset.pageType||null,title:document.title,url:window.location.href},ts:new Date().toISOString(),version:n.zflex_version||null}}function i(e,t={}){if(!e)return;const n=$(e,t);s.push(n),p(),console.log(`[Analytics] Event Queued: ${e}`,t)}async function m(e,t=1){if(!e||e.length===0)return{ok:!0};try{const n=e[0].storeId;return n?(await v(n,e),{ok:!0}):{ok:!1,error:"Missing storeId"}}catch(n){return t<N?(await new Promise(r=>setTimeout(r,1e3*t)),m(e,t+1)):{ok:!1,error:String(n)}}}async function f(){if(!(l||s.length===0)){l=!0;try{const e=s.slice(0,L),t=await m(e);t&&t.ok&&(s.splice(0,e.length),p())}finally{l=!1}}}function q(){d&&clearInterval(d),d=setInterval(f,M),document.addEventListener("visibilitychange",()=>document.visibilityState==="hidden"&&f()),window.addEventListener("beforeunload",()=>{if(s.length!==0)try{const e=h(),t=e.apiEndpoints?.trackEvent;navigator.sendBeacon&&t&&(navigator.sendBeacon(t,JSON.stringify({storeId:e.storeId,events:s})),s=[],p())}catch(e){console.warn("[Analytics] Beacon failed.",e)}})}function Q(){const e={"stacy:message_sent":t=>i("send_stacy_message",{length:t.message.length}),"cart:item_added":t=>i("add_to_cart",t.item),"cart:item_removed":t=>i("remove_from_cart",t.item),"cart:cleared":()=>i("clear_cart"),"checkout:purchase_success":t=>i("purchase",t.order)};for(const[t,n]of Object.entries(e))g.addEventListener(t,r=>n(r.detail))}function F(e){const t=e.getAttribute("data-analytics-type")||"",n=e.getAttribute("data-analytics-payload");let r={};if(n)try{r=JSON.parse(n)}catch(o){console.warn("[Analytics] Échec parsing payload, attribut brut:",{payloadAttr:n,error:o})}return{type:t,payload:r}}function U(){document.addEventListener("click",e=>{const t=Date.now();if(t-y<J){e.stopImmediatePropagation();return}y=t;const r=e.target.closest("[data-analytics-type]");if(!r)return;const{type:o,payload:c}=F(r);o&&i(o,c)},!0)}function V(){R(),q(),U(),Q(),console.log("[Analytics] Module V3.2 (The Final Cut) initialisé.")}function E({path:e,title:t,extra:n={}}={}){i("pageview",{url:e||window.location.href,title:t||document.title,...n})}function _(e,t={}){i(e,t)}window.zflexAnalytics={track:_,trackPageview:E,flush:f,getQueue:()=>s};const G=Object.freeze(Object.defineProperty({__proto__:null,initAnalytics:V,track:_,trackPageview:E},Symbol.toStringTag,{value:"Module"}));export{O as a,H as b,b as c,G as d,K as e,g as f,z as g,x as h,k as i,T as j,j as k,P as l,C as s,E as t};
